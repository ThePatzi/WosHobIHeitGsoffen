<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-swipeable-container/iron-swipeable-container.html">
<link rel="import" href="../../bower_components/iron-scroll-target-behavior/iron-scroll-target-behavior.html">

<link rel="import" href="../list-row/list-row.html">
<link rel="import" href="../item-edit-dialog/item-edit-dialog.html">
<link rel="import" href="list-input.html">

<dom-module id="whihg-list">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment iron-positioning"></style>
    <style>
      :host {
        display: block;
      }
      
      .sign {
        margin-right: 2px;
        text-align: center;
      }
      
      .euro.sign {
        width: 60px;
      }
      
      .amount.sign {
        width: 50px;
      }
      
      .sign-spacer {
        width: 100px;
      }
      
      .row {
        --row-style: {
          border-bottom: 1px solid lightgray;
        }
      }
      
      .header {
        border-bottom: 1px solid black;
      }
      
      #editDialog {
        --paper-dialog: {
          width: 500px;
        };
      }
      
      @media (max-width: 500px) {
        #editDialog {
          --paper-dialog: {
            left: 0;
            right: 0;
          };
        }
      }
    </style>
    
    <div class="vertical layout fit">
      <div class="horizontal layout header center">
        <span class="flex"></span>
        <span class="euro sign">&euro;</span>
        <span class="amount sign">#</span>
        <span class="sign-spacer horizontal layout">
          <span class="flex"></span>
          <paper-icon-button icon="done-all" on-tap="__onAllDoneTap"
                             style="margin-right: 10px"></paper-icon-button>
        </span>
      </div>
      <div class="flex" style="overflow: auto">
        <template is="dom-repeat" items="{{items}}" as="item">
          <list-row class="row" item="{{item}}"
                    on-remove-item="__handleRemoveItem"
                    on-edit-item="__handleEditItem"
                    on-add-favorite-item="__handleAddFavoriteItem"
                    is-favorite="[[__computeIsFavorite(item.name, item.price, favorites)]]"></list-row>
        </template>
      </div>
      <list-input on-add-item="__handleAddItem"
                  favorites="[[favorites]]"></list-input>
      <div style="margin: 10px 0 15px; font-weight: bold;">
        Gesamt: [[_sum]]
      </div>
    </div>
    
    <paper-dialog id="clearListDialog" always-on-top>
      <div>Do you really want to delete all items?</div>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-tap="__clearAllItemsAccept">Accept</paper-button>
      </div>
    </paper-dialog>
    
    <item-edit-dialog id="editDialog" item="{{_editItem}}"
                      on-item-save="__onItemSave"></item-edit-dialog>
  
  </template>
  <script>
    Polymer({
      is: 'whihg-list',
      
      properties: {
        items: {
          type: Array,
          notify: true,
          value: []
        },
        
        favorites: {
          type: Array,
          notify: true,
          value: []
        },
        
        _sum: {
          type: Number,
          computed: '__calculateSum(items.*)'
        },
        
        _editItem: {
          type: Object,
          notify: true,
          value: {}
        }
        
      },
      
      __calculateSum: function () {
        var sum = 0;
        
        for (var i = 0; i < this.items.length; i++) {
          var item = this.items[i];
          var amount = item.amount || 0;
          var price = item.price || 0;
          
          sum += amount * price;
        }
        
        return sum.toFixed(2);
      },
      
      _removeItem: function (item) {
        var index = this.items.indexOf(item);
        this.splice('items', index, 1);
      },
      
      _fireShowToast: function (message) {
        this.fire('show-toast', {message: message});
      },
      
      __onAllDoneTap: function (e) {
        if (this.items.length <= 0) {
          return;
        }
        
        this.$.clearListDialog.open();
      },
      
      __clearAllItemsAccept: function (e) {
        this._clearAllItems();
      },
      
      _clearAllItems: function () {
        this.splice('items', 0, this.items.length);
      },
      
      __handleRemoveItem: function (e) {
        this._removeItem(e.detail.item);
        this._fireShowToast(e.detail.item.name + ' removed')
      },
      
      __handleEditItem: function (e) {
        var index = this.items.indexOf(e.model.item);
        this.$.editDialog.show(index, e.model.item);
      },
      
      __handleAddItem: function (e) {
        var item = e.detail;
        
        this.push('items', {
          name: item.name,
          price: item.price,
          amount: item.amount
        });
      },
      
      __onItemSave: function (e) {
        var detail = e.detail;
        this.set('items.' + detail.index, detail.item);
      },
      
      __handleAddFavoriteItem: function (e) {
        var item = e.detail.item;
        
        var price = parseFloat(item.price || 0);
        var isFavorite = false;
        var index = -1;
        
        for (var i = 0; i < this.favorites.length; i++) {
          var favorite = this.favorites[i];
          
          if (item.name === favorite.name && price === parseFloat(favorite.price || 0)) {
            isFavorite = true;
            index = i;
            break;
          }
        }
        
        if (isFavorite) {
          this.splice('favorites', index, 1);
        } else {
          this.push('favorites', {
            name: item.name,
            price: parseFloat(item.price)
          });
        }
      },
      
      __computeIsFavorite(name, price, favorites){
        price = parseFloat(price || 0);
        
        for (var i = 0; i < favorites.length; i++) {
          var favorite = favorites[i];
          
          if (name === favorite.name && price === parseFloat(favorite.price || 0)) {
            return true;
          }
        }
        
        return false;
      }
    })
    ;
  </script>
</dom-module>